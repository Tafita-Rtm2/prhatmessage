<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Auth Container -->
  <div id="authContainer">
    <div>
      <h2>Register</h2>
      <input type="text" id="registerUsername" placeholder="Username" />
      <input type="email" id="registerEmail" placeholder="Email" />
      <input type="password" id="registerPassword" placeholder="Password" />
      <input type="file" id="profilePic" />
      <button onclick="register()">Register</button>
    </div>
    <div>
      <h2>Login</h2>
      <input type="email" id="loginEmail" placeholder="Email" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button onclick="login()">Login</button>
      <button onclick="resetPassword()">Forgot Password?</button>
    </div>
  </div>

  <!-- Chat Interface -->
  <div id="chatContainer" style="display: none;">
    <div>
      <input type="text" id="searchInput" placeholder="Search by email or username" />
      <button onclick="searchFriend()">Search</button>
      <button onclick="loadAllUsers()">All Users</button>
      <div id="currentUser"></div>
    </div>
    <div id="friendsList"></div>
    <div id="messages"></div>
    <div>
      <input type="text" id="msgTxt" placeholder="Your message..." />
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendPasswordResetEmail,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      child,
      onChildAdded
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    import {
      getStorage,
      ref as sRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDbP-yKWXD4L1HowJt3ZSyEpMUMrzJZjI",
      authDomain: "tafitafaceboot.firebaseapp.com",
      databaseURL: "https://tafitafaceboot-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tafitafaceboot",
      storageBucket: "tafitafaceboot.appspot.com",
      messagingSenderId: "893787639070",
      appId: "1:893787639070:web:e5dd2798f3cb2b6fa24d0f",
      measurementId: "G-H64J1YYPYE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let currentUserEmail = "";
    let currentUsername = "";
    let receiver = "";

    function encodeEmail(email) {
      return email.replace(/\./g, "(dot)");
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserEmail = user.email;
        get(child(ref(db), "users/" + encodeEmail(currentUserEmail))).then(snapshot => {
          if (snapshot.exists()) {
            currentUsername = snapshot.val().username;
            showChat();
            document.getElementById("currentUser").textContent = "Logged in as " + currentUsername;
          }
        });
      }
    });

    window.register = async function () {
      const email = document.getElementById("registerEmail").value;
      const password = document.getElementById("registerPassword").value;
      const username = document.getElementById("registerUsername").value;
      const profilePic = document.getElementById("profilePic").files[0];

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        let photoURL = "";
        if (profilePic) {
          const picRef = sRef(storage, `profilePics/${encodeEmail(email)}`);
          await uploadBytes(picRef, profilePic);
          photoURL = await getDownloadURL(picRef);
        }
        await set(ref(db, "users/" + encodeEmail(email)), {
          email,
          username,
          photoURL
        });
        alert("Registered! Now login.");
      } catch (e) {
        alert("Register error: " + e.message);
      }
    };

    window.login = async function () {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        alert("Login failed: " + e.message);
      }
    };

    window.resetPassword = async function () {
      const email = prompt("Enter your email:");
      if (email) {
        await sendPasswordResetEmail(auth, email);
        alert("Password reset email sent.");
      }
    };

    function showChat() {
      document.getElementById("authContainer").style.display = "none";
      document.getElementById("chatContainer").style.display = "block";
    }

    window.searchFriend = async function () {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const list = document.getElementById("friendsList");
      list.innerHTML = "";
      const snapshot = await get(child(ref(db), "users"));
      snapshot.forEach(child => {
        const user = child.val();
        if (
          (user.username && user.username.toLowerCase().includes(input)) ||
          (user.email && user.email.toLowerCase().includes(input))
        ) {
          if (user.email !== currentUserEmail) {
            const btn = document.createElement("button");
            btn.textContent = user.username || user.email;
            btn.onclick = () => {
              receiver = user.email;
              loadMessages();
            };
            list.appendChild(btn);
          }
        }
      });
    };

    window.loadAllUsers = async function () {
      const list = document.getElementById("friendsList");
      list.innerHTML = "";
      const snapshot = await get(child(ref(db), "users"));
      snapshot.forEach(child => {
        const user = child.val();
        if (user.email !== currentUserEmail) {
          const btn = document.createElement("button");
          btn.textContent = user.username || user.email;
          btn.onclick = () => {
            receiver = user.email;
            loadMessages();
          };
          list.appendChild(btn);
        }
      });
    };

    function getChatId(user1, user2) {
      return [user1, user2].sort().join("-").replace(/\./g, "(dot)");
    }

    function loadMessages() {
      const msgBox = document.getElementById("messages");
      msgBox.innerHTML = "";
      const chatId = getChatId(currentUserEmail, receiver);
      const chatRef = ref(db, "privateMessages/" + chatId);
      onChildAdded(chatRef, (snapshot) => {
        const msg = snapshot.val();
        const div = document.createElement("div");
        div.textContent = (msg.sender === currentUserEmail ? "You" : msg.sender) + ": " + msg.msg;
        msgBox.appendChild(div);
        msgBox.scrollTop = msgBox.scrollHeight;
      });
    }

    window.sendMsg = function () {
      const txt = document.getElementById("msgTxt").value;
      if (!receiver || !txt.trim()) return;
      const chatId = getChatId(currentUserEmail, receiver);
      const timestamp = new Date().getTime();
      set(ref(db, "privateMessages/" + chatId + "/" + timestamp), {
        sender: currentUserEmail,
        msg: txt.trim()
      });
      document.getElementById("msgTxt").value = "";
    };
  </script>
</body>
</html>
