<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>RTM Messagerie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(to bottom right, #0f0c29, #302b63, #24243e);
      color: #fff;
    }

    header {
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 24px;
    }

    .user-list-icon {
      cursor: pointer;
    }

    .container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    #authSection, #chatSection, #userListSection, #searchSection {
      display: none;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 5px;
    }

    input[type="submit"], button {
      background: #00c6ff;
      color: white;
      cursor: pointer;
    }

    .message {
      margin: 10px 0;
    }

    .message.you {
      text-align: right;
      color: #0f0;
    }

    .message.other {
      text-align: left;
      color: #0ff;
    }

    .user-card {
      background: rgba(255, 255, 255, 0.1);
      margin: 5px 0;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <header>
    <h1>RTM Futur Messenger</h1>
    <div class="user-list-icon" onclick="showUserList()">ðŸ‘¥</div>
  </header>

  <div class="container">
    <div id="authSection">
      <h2>Connexion / Inscription</h2>
      <input type="email" id="email" placeholder="Adresse e-mail">
      <input type="password" id="password" placeholder="Mot de passe">
      <input type="text" id="pseudo" placeholder="Pseudo (si nouveau compte)">
      <input type="submit" value="Connexion / Inscription" onclick="auth()">
      <button onclick="resetPassword()">Mot de passe oubliÃ©</button>
    </div>

    <div id="searchSection">
      <h3>Rechercher un ami</h3>
      <input type="text" id="searchInput" placeholder="Email ou pseudo">
      <button onclick="searchUser()">Rechercher</button>
      <div id="searchResults"></div>
    </div>

    <div id="chatSection">
      <h2 id="chatWith"></h2>
      <div id="messages"></div>
      <input type="text" id="msgInput" placeholder="Tapez votre message">
      <button onclick="sendMessage()">Envoyer</button>
    </div>

    <div id="userListSection">
      <h3>Utilisateurs du site</h3>
      <div id="userList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, push, onChildAdded, get, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDbP-yKWXD4L1HowJt3ZSyEpMUMrzJZjI",
      authDomain: "tafitafaceboot.firebaseapp.com",
      databaseURL: "https://tafitafaceboot-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tafitafaceboot",
      storageBucket: "tafitafaceboot.appspot.com",
      messagingSenderId: "893787639070",
      appId: "1:893787639070:web:e5dd2798f3cb2b6fa24d0f",
      measurementId: "G-H64J1YYPYE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const authSection = document.getElementById('authSection');
    const chatSection = document.getElementById('chatSection');
    const searchSection = document.getElementById('searchSection');
    const userListSection = document.getElementById('userListSection');
    const messages = document.getElementById('messages');
    const chatWith = document.getElementById('chatWith');
    let currentUser = null;
    let currentChat = null;

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        authSection.style.display = 'none';
        searchSection.style.display = 'block';
        loadUserList();
      } else {
        authSection.style.display = 'block';
        searchSection.style.display = 'none';
        chatSection.style.display = 'none';
      }
    });

    window.auth = async function() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const pseudo = document.getElementById('pseudo').value;
      try {
        const result = await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        const result = await createUserWithEmailAndPassword(auth, email, password);
        set(ref(db, 'users/' + result.user.uid), {
          email: email,
          pseudo: pseudo || email.split('@')[0],
          uid: result.user.uid
        });
      }
    }

    window.resetPassword = function() {
      const email = document.getElementById('email').value;
      if (!email) return alert("Entrez votre email");
      sendPasswordResetEmail(auth, email)
        .then(() => alert("Lien de rÃ©initialisation envoyÃ©."))
        .catch(err => alert(err.message));
    }

    window.searchUser = async function() {
      const input = document.getElementById('searchInput').value.toLowerCase();
      const resultsDiv = document.getElementById('searchResults');
      resultsDiv.innerHTML = '';
      const snap = await get(ref(db, 'users'));
      snap.forEach(child => {
        const u = child.val();
        if (u.email.toLowerCase().includes(input) || u.pseudo.toLowerCase().includes(input)) {
          const el = document.createElement('div');
          el.className = 'user-card';
          el.innerText = u.pseudo + ' (' + u.email + ')';
          el.onclick = () => openChat(u);
          resultsDiv.appendChild(el);
        }
      });
    }

    function openChat(user) {
      currentChat = user;
      chatWith.innerText = 'Discussion avec ' + user.pseudo;
      chatSection.style.display = 'block';
      messages.innerHTML = '';

      const chatId = [currentUser.uid, user.uid].sort().join('_');
      onChildAdded(ref(db, 'chats/' + chatId), (data) => {
        const msg = data.val();
        const div = document.createElement('div');
        div.className = 'message ' + (msg.from === currentUser.uid ? 'you' : 'other');
        div.innerText = msg.text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      });
    }

    window.sendMessage = function() {
      const text = document.getElementById('msgInput').value;
      if (!text || !currentChat) return;
      const chatId = [currentUser.uid, currentChat.uid].sort().join('_');
      push(ref(db, 'chats/' + chatId), {
        from: currentUser.uid,
        to: currentChat.uid,
        text: text,
        timestamp: Date.now()
      });
      document.getElementById('msgInput').value = '';
    }

    window.showUserList = async function() {
      userListSection.style.display = userListSection.style.display === 'block' ? 'none' : 'block';
      const listDiv = document.getElementById('userList');
      listDiv.innerHTML = '';
      const snap = await get(ref(db, 'users'));
      snap.forEach(child => {
        const u = child.val();
        if (u.uid !== currentUser.uid) {
          const el = document.createElement('div');
          el.className = 'user-card';
          el.innerText = u.pseudo;
          el.onclick = () => openChat(u);
          listDiv.appendChild(el);
        }
      });
    }
  </script>
</body>
</html>
